<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utility Tracker (Cash Flow)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPDF & AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .tab-btn.active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 600; }
        .tab-btn { color: #64748b; font-weight: 500; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-2 text-blue-600 font-bold text-xl">
                    <i class="fa-solid fa-chart-pie"></i> UtilityTracker
                </div>
                <div class="flex space-x-4">
                    <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-btn px-3 py-2 text-sm focus:outline-none active">Dashboard</button>
                    <button onclick="switchTab('add-bill')" id="tab-add-bill" class="tab-btn px-3 py-2 text-sm focus:outline-none">Add Bill</button>
                    <button onclick="switchTab('people')" id="tab-people" class="tab-btn px-3 py-2 text-sm focus:outline-none">People</button>
                    <button onclick="switchTab('settings')" id="tab-settings" class="tab-btn px-3 py-2 text-sm focus:outline-none text-orange-600"><i class="fa-solid fa-floppy-disk mr-1"></i>Data</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto p-4 mt-4">

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="space-y-6">
            <div class="flex justify-between items-end">
                <h2 class="text-2xl font-bold text-slate-800">Active Bills</h2>
                <button onclick="switchTab('add-bill')" class="text-sm bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700">
                    <i class="fa-solid fa-plus mr-1"></i> New Bill
                </button>
            </div>
            <div id="bills-list" class="space-y-4"></div>
        </div>

        <!-- VIEW: ADD BILL -->
        <div id="view-add-bill" class="hidden bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-xl font-bold text-slate-800 mb-6">Create New Bill</h2>
            
            <!-- Bill Details Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Bill Name</label>
                    <input type="text" id="new-bill-name" placeholder="e.g. Nov Hydro" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Total Amount ($)</label>
                    <input type="number" id="new-bill-total" placeholder="0.00" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <!-- DATE 1: Bill Date -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Bill Issue Date (Paper Date)</label>
                    <input type="date" id="new-bill-date" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none text-gray-500">
                </div>
                <!-- DATE 2: Withdrawal Date -->
                 <div class="md:col-span-2 bg-orange-50 p-3 rounded border border-orange-200">
                    <label class="block text-sm font-bold text-orange-800 mb-1"><i class="fa-solid fa-calendar-check mr-1"></i> Auto-Pay / Withdrawal Date</label>
                    <p class="text-xs text-orange-600 mb-2">This date determines which month the expense belongs to.</p>
                    <input type="date" id="new-bill-withdrawal-date" class="w-full p-2 border border-orange-300 rounded focus:ring-2 focus:ring-orange-500 outline-none font-bold text-gray-800">
                </div>
            </div>

            <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-sm font-medium text-gray-700">Select Payers & Splits</label>
                    <div class="text-xs space-x-2">
                        <button onclick="applySplitPreset('even')" class="text-blue-600 hover:underline">Split Evenly</button>
                        <span class="text-gray-300">|</span>
                        <button onclick="applySplitPreset('4060')" class="text-blue-600 hover:underline">40/60</button>
                    </div>
                </div>
                <div id="split-participants" class="space-y-2 border p-4 rounded-lg bg-gray-50 max-h-60 overflow-y-auto"></div>
                <div class="flex justify-end mt-2">
                    <span id="split-total-check" class="text-sm font-bold text-red-500">Total: 0%</span>
                </div>
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="switchTab('dashboard')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                <button onclick="saveBill()" class="px-6 py-2 bg-green-600 text-white font-bold rounded hover:bg-green-700 shadow">Save Bill</button>
            </div>
        </div>

        <!-- VIEW: PEOPLE MANAGER -->
        <div id="view-people" class="hidden bg-white p-6 rounded-xl shadow-md max-w-lg mx-auto">
            <h2 class="text-xl font-bold text-slate-800 mb-4">Manage People</h2>
            <div class="flex gap-2 mb-6">
                <input type="text" id="new-person-name" placeholder="Enter Name" class="flex-1 p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                <button onclick="addPerson()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add</button>
            </div>
            <ul id="people-list" class="divide-y divide-gray-100"></ul>
        </div>

        <!-- VIEW: SETTINGS & REPORTS -->
        <div id="view-settings" class="hidden bg-white p-6 rounded-xl shadow-md max-w-xl mx-auto">
            
            <!-- REPORTS SECTION -->
            <div class="border-b pb-6 mb-6">
                <h2 class="text-xl font-bold text-slate-800 mb-4"><i class="fa-solid fa-money-bill-transfer mr-2"></i>Cash Flow Reports</h2>
                <p class="text-xs text-gray-500 mb-4">
                    Reports are based on <b>Withdrawal Dates</b> (Money Out) and <b>Payment Dates</b> (Money In).
                </p>
                
                <div class="bg-blue-50 border border-blue-100 p-4 rounded-lg mb-4">
                    <label class="block text-sm font-bold text-blue-800 mb-2">Monthly Cash Report</label>
                    <div class="flex gap-2">
                        <input type="month" id="report-month" class="flex-1 p-2 border rounded text-sm">
                        <button onclick="generateReport('month')" class="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700 text-sm shadow">
                            Generate PDF
                        </button>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="generateReport('all')" class="flex-1 bg-slate-700 text-white px-4 py-3 rounded font-bold hover:bg-slate-800 text-sm shadow">
                        <i class="fa-solid fa-list mr-1"></i> Print All History
                    </button>
                </div>
            </div>

            <!-- DATA MANAGEMENT -->
            <h2 class="text-xl font-bold text-slate-800 mb-4"><i class="fa-solid fa-database mr-2"></i>Data Transfer</h2>
            <div class="space-y-6">
                <div class="border p-4 rounded-lg bg-gray-50 border-gray-200">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button onclick="copyToEmail()" class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700 text-sm">
                             Copy to Email
                        </button>
                        <button onclick="exportData()" class="flex-1 bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded font-medium hover:bg-gray-100 text-sm">
                             Download File
                        </button>
                    </div>
                    
                    <div class="mt-3">
                        <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(this)">
                        <button onclick="document.getElementById('import-file').click()" class="w-full bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded font-medium hover:bg-gray-100 text-sm">
                             <i class="fa-solid fa-upload mr-2"></i>Upload Backup File
                        </button>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <p class="text-xs text-gray-500 mb-1">Or paste data code:</p>
                        <div class="flex gap-2">
                            <input id="paste-import-area" placeholder="Paste data here..." class="flex-1 p-2 text-xs border rounded">
                            <button onclick="importFromText()" class="bg-gray-800 text-white px-3 py-1 rounded text-xs font-bold">Load</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- NOTIFICATION SYSTEM ---
        function showStatus(msg, isError = false) {
            const statusDiv = document.createElement('div');
            statusDiv.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg text-white font-bold z-[100] ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            statusDiv.innerText = msg;
            document.body.appendChild(statusDiv);
            setTimeout(() => statusDiv.remove(), 3000);
        }

        // --- DATA STORE ---
        // New Field: withdrawalDate added to bill object
        let appData = { people: [], bills: [] };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            // Default dates
            const now = new Date();
            const todayStr = now.toISOString().slice(0,10);
            document.getElementById('new-bill-date').value = todayStr;
            document.getElementById('new-bill-withdrawal-date').value = todayStr;
            document.getElementById('report-month').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            renderPeopleList();
            renderDashboard();
        });

        function loadData() {
            const saved = localStorage.getItem('utilityTrackerData_file_v3');
            if (saved) appData = JSON.parse(saved);
        }

        function saveData() {
            localStorage.setItem('utilityTrackerData_file_v3', JSON.stringify(appData));
            renderDashboard(); 
        }

        // --- HELPER ---
        function getPaidTotal(split) {
            if (split.payments && Array.isArray(split.payments)) {
                return split.payments.reduce((acc, p) => acc + (parseFloat(p.amount) || 0), 0);
            }
            return parseFloat(split.paidAmount) || 0;
        }

        // --- NAVIGATION ---
        function switchTab(tabId) {
            ['dashboard', 'add-bill', 'people', 'settings'].forEach(id => {
                document.getElementById(`view-${id}`).classList.add('hidden');
                document.getElementById(`tab-${id}`).classList.remove('active');
            });
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).classList.add('active');
            if (tabId === 'add-bill') initNewBillForm();
        }

        // --- PEOPLE ---
        function addPerson() {
            const input = document.getElementById('new-person-name');
            const name = input.value.trim();
            if (name && !appData.people.includes(name)) {
                appData.people.push(name); saveData(); renderPeopleList(); input.value = ''; showStatus("Person Added!");
            }
        }
        function deletePerson(name) {
            appData.people = appData.people.filter(p => p !== name); saveData(); renderPeopleList(); showStatus("Person Removed.");
        }
        function renderPeopleList() {
            const list = document.getElementById('people-list');
            if (appData.people.length === 0) { list.innerHTML = '<li class="py-4 text-center text-gray-400 italic">No people added yet.</li>'; return; }
            list.innerHTML = appData.people.map(p => `
                <li class="flex justify-between items-center py-3">
                    <span class="font-medium text-gray-700">${p}</span>
                    <button onclick="deletePerson('${p}')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>
                </li>`).join('');
        }

        // --- BILLS ---
        function initNewBillForm() {
            const container = document.getElementById('split-participants');
            if (appData.people.length === 0) { container.innerHTML = '<div class="text-center p-4"><a href="#" onclick="switchTab(\'people\')" class="text-blue-600 underline">Add People First</a></div>'; return; }
            container.innerHTML = appData.people.map((p, idx) => `
                <div class="flex items-center justify-between bg-white p-2 border rounded shadow-sm">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="check-${idx}" class="participant-check w-4 h-4 text-blue-600" onchange="updateSplitTotal()">
                        <label for="check-${idx}" class="text-gray-700 select-none cursor-pointer">${p}</label>
                    </div>
                    <div class="flex items-center gap-1">
                        <input type="number" id="percent-${idx}" placeholder="0" class="w-16 p-1 border rounded text-right text-sm" oninput="updateSplitTotal()">
                        <span class="text-gray-500 text-sm">%</span>
                    </div>
                </div>`).join('');
            updateSplitTotal();
        }
        function updateSplitTotal() {
            let total = 0;
            appData.people.forEach((_, idx) => {
                const check = document.getElementById(`check-${idx}`);
                const input = document.getElementById(`percent-${idx}`);
                if (check && check.checked) { input.disabled = false; input.classList.remove('bg-gray-100'); total += parseFloat(input.value) || 0; }
                else if(input) { input.disabled = true; input.classList.add('bg-gray-100'); input.value = ''; }
            });
            const display = document.getElementById('split-total-check');
            display.innerText = `Total: ${total}%`;
            display.className = Math.abs(total - 100) < 0.1 ? "text-sm font-bold text-green-600" : "text-sm font-bold text-red-500";
        }
        function applySplitPreset(type) {
            const checks = document.querySelectorAll('.participant-check');
            let selectedIndices = [];
            checks.forEach((c, i) => { if(c.checked) selectedIndices.push(i); });
            if (selectedIndices.length === 0) { showStatus("Select people first.", true); return; }
            if (type === 'even') {
                const share = (100 / selectedIndices.length).toFixed(2);
                selectedIndices.forEach(idx => document.getElementById(`percent-${idx}`).value = share);
            } else if (type === '4060') {
                if (selectedIndices.length !== 2) { showStatus("Select exactly 2 people.", true); return; }
                document.getElementById(`percent-${selectedIndices[0]}`).value = 40;
                document.getElementById(`percent-${selectedIndices[1]}`).value = 60;
            }
            updateSplitTotal();
        }
        
        function saveBill() {
            const name = document.getElementById('new-bill-name').value;
            const total = parseFloat(document.getElementById('new-bill-total').value);
            const date = document.getElementById('new-bill-date').value; // Issue Date
            const withdrawalDate = document.getElementById('new-bill-withdrawal-date').value; // Cash Flow Date

            let splitTotal = 0; let splits = [];
            appData.people.forEach((p, idx) => {
                const check = document.getElementById(`check-${idx}`);
                const percentInput = document.getElementById(`percent-${idx}`);
                if (check && check.checked) {
                    const pct = parseFloat(percentInput.value) || 0;
                    splitTotal += pct;
                    const amount = (total * (pct / 100)).toFixed(2);
                    splits.push({ name: p, percent: pct, amount: parseFloat(amount), paidAmount: 0, payments: [] });
                }
            });
            if (!name || isNaN(total) || total <= 0) { showStatus("Check bill details.", true); return; }
            if (!date || !withdrawalDate) { showStatus("Both dates required.", true); return; }
            if (Math.abs(splitTotal - 100) > 0.1) { showStatus("Total must be 100%.", true); return; }

            const newBill = { id: Date.now(), name, totalAmount: total, date, withdrawalDate, splits };
            appData.bills.unshift(newBill);
            saveData();
            document.getElementById('new-bill-name').value = '';
            document.getElementById('new-bill-total').value = '';
            showStatus("Bill Saved!");
            switchTab('dashboard');
        }

        // --- DASHBOARD ---
        function renderDashboard() {
            const container = document.getElementById('bills-list');
            if (appData.bills.length === 0) { container.innerHTML = '<div class="text-center py-10 text-gray-400">No bills yet.</div>'; return; }
            
            // Sort bills by Withdrawal Date (since that's the "real" payment date for owner)
            const sortedBills = [...appData.bills].sort((a,b) => new Date(b.withdrawalDate || b.date) - new Date(a.withdrawalDate || a.date));
            const today = new Date().toISOString().slice(0,10);

            container.innerHTML = sortedBills.map(bill => {
                const billTotalPaid = bill.splits.reduce((acc, s) => acc + getPaidTotal(s), 0);
                const isFullyPaid = billTotalPaid >= bill.totalAmount - 0.1;
                let statusColor = isFullyPaid ? 'bg-green-100 text-green-700' : (billTotalPaid > 0 ? 'bg-orange-100 text-orange-700' : 'bg-red-100 text-red-700');
                let statusText = isFullyPaid ? 'PAID' : (billTotalPaid > 0 ? 'PARTIAL' : 'PENDING');
                const wdDisplay = bill.withdrawalDate ? `<span class="text-orange-600 ml-2 text-[10px]"><i class="fa-solid fa-calendar-check"></i> Withdraw: ${bill.withdrawalDate}</span>` : '';

                return `
                <div class="bg-white rounded-lg shadow border border-gray-100 overflow-hidden">
                    <div class="p-4 flex justify-between items-center cursor-pointer hover:bg-gray-50 transition" onclick="toggleDetails(${bill.id})">
                        <div>
                            <h3 class="font-bold text-gray-800">${bill.name}</h3>
                            <p class="text-xs text-gray-500">Issued: ${bill.date} ${wdDisplay}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-gray-900">$${bill.totalAmount.toFixed(2)}</p>
                            <span class="text-xs px-2 py-0.5 rounded-full font-bold ${statusColor}">${statusText}</span>
                        </div>
                    </div>
                    <div id="details-${bill.id}" class="hidden bg-gray-50 border-t border-gray-200 p-4">
                        <table class="w-full text-sm mb-3">
                            <tbody class="divide-y divide-gray-200">
                                ${bill.splits.map((s, idx) => {
                                    const owe = s.amount;
                                    const paid = getPaidTotal(s);
                                    const balance = paid - owe;
                                    const isPaid = paid >= owe - 0.01;
                                    let rowColor = isPaid ? 'text-green-600' : (paid > 0 ? 'text-orange-600' : 'text-red-500');
                                    let statusDetail = balance > 0.01 ? `<span class="text-green-600 font-bold text-xs">(+ $${balance.toFixed(2)} Credit)</span>` : `<span class="text-gray-400 font-normal">$${owe.toFixed(2)}</span>`;
                                    return `
                                    <tr>
                                        <td class="py-3 font-medium">${s.name}</td>
                                        <td class="py-3 text-right ${rowColor} font-bold">$${paid.toFixed(2)} / ${statusDetail}</td>
                                        <td class="py-3 text-right">
                                            <div class="flex justify-end items-center gap-2">
                                                <input type="number" id="pay-input-${bill.id}-${idx}" placeholder="$" class="w-16 p-1 text-xs border rounded">
                                                <input type="date" id="pay-date-${bill.id}-${idx}" value="${today}" class="w-24 p-1 text-xs border rounded text-gray-500">
                                                <button onclick="logPayment(${bill.id}, ${idx})" class="bg-blue-600 text-white px-2 py-1 rounded text-xs">Add</button>
                                                <button onclick="undoPayment(${bill.id}, ${idx})" class="text-gray-400 hover:text-red-500 text-xs px-1" title="Reset"><i class="fa-solid fa-rotate-left"></i></button>
                                            </div>
                                        </td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                        <div class="text-right mt-2"><button onclick="deleteBill(${bill.id})" class="text-xs text-red-500 hover:underline">Delete Bill</button></div>
                    </div>
                </div>`;
            }).join('');
        }
        window.toggleDetails = (id) => { const el = document.getElementById(`details-${id}`); if(el) el.classList.toggle('hidden'); }
        
        window.logPayment = (billId, splitIndex) => {
            const input = document.getElementById(`pay-input-${billId}-${splitIndex}`);
            const dateInput = document.getElementById(`pay-date-${billId}-${splitIndex}`);
            const amount = parseFloat(input.value);
            const date = dateInput.value;
            if (isNaN(amount) || amount <= 0) { showStatus("Invalid Amount.", true); return; }
            if (!date) { showStatus("Invalid Date.", true); return; }
            const bill = appData.bills.find(b => b.id === billId);
            if (bill) { 
                const split = bill.splits[splitIndex];
                split.paidAmount = (parseFloat(split.paidAmount) || 0) + amount;
                if (!split.payments) split.payments = [];
                split.payments.push({ amount: amount, date: date });
                saveData(); input.value = ''; showStatus("Payment Logged!");
            }
        }
        window.undoPayment = (billId, splitIndex) => {
            if(confirm("Reset payments?")) {
                const bill = appData.bills.find(b => b.id === billId);
                if(bill) { bill.splits[splitIndex].paidAmount = 0; bill.splits[splitIndex].payments = []; saveData(); showStatus("Payments Reset."); }
            }
        }
        window.deleteBill = (id) => { appData.bills = appData.bills.filter(b => b.id !== id); saveData(); showStatus("Bill Deleted."); }

        // --- REPORTING (UPDATED FOR WITHDRAWAL DATE) ---
        window.generateReport = (type) => {
            let collectedInPeriod = 0;
            let billsIssuedInPeriod = 0; // Means "Withdrawn in Period"
            let reportTitle = "";
            let collectedRows = [];
            let expenseRows = [];

            const monthInput = document.getElementById('report-month').value;
            if (type === 'month' && !monthInput) return showStatus("Select month first.", true);

            // 1. Calculate Expenses (Money OUT) based on WITHDRAWAL DATE
            appData.bills.forEach(b => {
                let includeBill = false;
                // Use withdrawalDate if available, otherwise fallback to issued date
                const refDate = b.withdrawalDate || b.date; 

                if (type === 'all') includeBill = true;
                if (type === 'month' && refDate.startsWith(monthInput)) includeBill = true;
                
                if (includeBill) {
                    billsIssuedInPeriod += b.totalAmount;
                    expenseRows.push([refDate, b.name, `$${b.totalAmount.toFixed(2)}`]);
                }
            });

            // 2. Calculate Collections (Money IN) based on PAYMENT DATE
            appData.bills.forEach(b => {
                b.splits.forEach(s => {
                    if (s.payments && Array.isArray(s.payments)) {
                        s.payments.forEach(p => {
                            let includePayment = false;
                            if (type === 'all') includePayment = true;
                            if (type === 'month' && p.date.startsWith(monthInput)) includePayment = true;

                            if (includePayment) {
                                collectedInPeriod += p.amount;
                                collectedRows.push([p.date, s.name, b.name, `$${p.amount.toFixed(2)}`]);
                            }
                        });
                    } else if (parseFloat(s.paidAmount) > 0) {
                        // Legacy: Use bill withdrawal date if no specific payment date
                        let includeLegacy = false;
                        const refDate = b.withdrawalDate || b.date;
                        if (type === 'all') includeLegacy = true;
                        if (type === 'month' && refDate.startsWith(monthInput)) includeLegacy = true;

                        if (includeLegacy) {
                            collectedInPeriod += s.paidAmount;
                            collectedRows.push([refDate, s.name, `${b.name} (Legacy)`, `$${s.paidAmount.toFixed(2)}`]);
                        }
                    }
                });
            });

            // 3. Calculate ALL TIME Payer Status (Cumulative Debt/Credit)
            let payerStats = {};
            appData.bills.forEach(b => {
                b.splits.forEach(s => {
                    const name = s.name || "Unknown";
                    if (!payerStats[name]) payerStats[name] = { billed: 0, paid: 0 };
                    payerStats[name].billed += s.amount;
                    payerStats[name].paid += getPaidTotal(s);
                });
            });

            let payerRows = [];
            Object.keys(payerStats).forEach(name => {
                const stats = payerStats[name];
                const balance = stats.paid - stats.billed;
                let balanceStr = "";
                
                if (balance > 0.005) {
                    balanceStr = `+ $${balance.toFixed(2)} (Credit)`;
                } else if (balance < -0.005) {
                    balanceStr = `- $${Math.abs(balance).toFixed(2)} (Pending)`;
                } else {
                    balanceStr = "Settled";
                }

                payerRows.push([name, `$${stats.billed.toFixed(2)}`, `$${stats.paid.toFixed(2)}`, balanceStr]);
            });

            if (type === 'month') reportTitle = `Cash Flow: ${monthInput}`;
            if (type === 'all') reportTitle = "All Time Cash Flow";

            // Sort rows
            collectedRows.sort((a,b) => new Date(b[0]) - new Date(a[0]));
            expenseRows.sort((a,b) => new Date(b[0]) - new Date(a[0]));

            if (collectedRows.length === 0 && billsIssuedInPeriod === 0) { showStatus("No data found.", true); return; }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFillColor(37, 99, 235); doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(22); doc.text(reportTitle, 105, 18, null, null, "center");
            
            // Summary
            const netFlow = collectedInPeriod - billsIssuedInPeriod; // Typically negative for utility bills
            doc.setTextColor(0,0,0); doc.setFontSize(12); doc.text("Cash Summary:", 14, 50);
            doc.autoTable({ 
                startY: 55, 
                head: [['Total Withdrawn (Out)', 'Total Collected (In)', 'Net Cost']], 
                body: [[`$${billsIssuedInPeriod.toFixed(2)}`, `$${collectedInPeriod.toFixed(2)}`, `$${Math.abs(netFlow).toFixed(2)}`]], 
                theme: 'grid',
                headStyles: { fillColor: [50, 50, 50] }
            });

            // Expenses Table
            doc.text("Expenses (Money Out - Based on Withdrawal Date):", 14, doc.lastAutoTable.finalY + 15);
            doc.autoTable({ 
                startY: doc.lastAutoTable.finalY + 20, 
                head: [['Withdrawal Date', 'Bill', 'Amount']], 
                body: expenseRows, 
                theme: 'striped',
                headStyles: { fillColor: [220, 38, 38] } // Red
            });
            
            // Collections Table
            doc.text("Collections (Money In - Based on Receipt Date):", 14, doc.lastAutoTable.finalY + 15);
            doc.autoTable({ 
                startY: doc.lastAutoTable.finalY + 20, 
                head: [['Date Received', 'Payer', 'Ref Bill', 'Amount']], 
                body: collectedRows, 
                theme: 'striped',
                headStyles: { fillColor: [22, 163, 74] } // Green
            });

            // Payer Status Table (All Time)
            doc.text("Current Payer Status (All Time History):", 14, doc.lastAutoTable.finalY + 15);
            doc.autoTable({ 
                startY: doc.lastAutoTable.finalY + 20, 
                head: [['Name', 'Total Billed', 'Total Paid', 'Current Balance']], 
                body: payerRows, 
                theme: 'striped',
                headStyles: { fillColor: [79, 70, 229] } // Indigo
            });

            doc.save(`CashFlow_${type}.pdf`);
            showStatus("PDF Downloaded!");
        }

        function copyToEmail() {
            const dataStr = JSON.stringify(appData);
            const textArea = document.createElement("textarea");
            textArea.value = dataStr; textArea.style.position = "fixed";
            document.body.appendChild(textArea); textArea.focus(); textArea.select();
            try { document.execCommand('copy'); showStatus("Copied! Paste into Email."); } catch (e) { showStatus("Copy failed.", true); }
            document.body.removeChild(textArea);
        }
        function importFromText() {
            const text = document.getElementById('paste-import-area').value.trim();
            if(!text) return showStatus("Paste data first.", true);
            try { appData = JSON.parse(text); saveData(); showStatus("Loaded!"); setTimeout(() => switchTab('dashboard'), 1000); } catch(e) { showStatus("Invalid Data.", true); }
        }
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr); node.setAttribute("download", `utility_backup_${new Date().toISOString().slice(0,10)}.json`);
            document.body.appendChild(node); node.click(); node.remove();
        }
        function importData(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { try { appData = JSON.parse(e.target.result); saveData(); showStatus("Loaded!"); setTimeout(() => switchTab('dashboard'), 1000); } catch(err) { showStatus("Error.", true); } };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
